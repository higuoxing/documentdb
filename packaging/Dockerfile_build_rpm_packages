ARG BASE_IMAGE=ubuntu:22.04
FROM ${BASE_IMAGE}

ARG POSTGRES_VERSION=16
ARG DOCUMENTDB_VERSION

RUN test -n "$DOCUMENTDB_VERSION" || (echo "DOCUMENTDB_VERSION not set" && false)

# Set timezone to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Update package manager and install dependencies
RUN apt-get update && apt-get install -y \
    wget \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    software-properties-common \
    python3 \
    python3-pip \
    gcc \
    g++ \
    make \
    cmake \
    git \
    pkg-config \
    libicu-dev \
    libkrb5-dev \
    postgresql-14 \
    postgresql-server-dev-14 \
    postgresql-contrib-14 \
    postgresql-plpython3-14 \
    rpm \
    rpmlint \
    && apt-get clean

# Set up locale
RUN apt-get install -y locales
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

COPY scripts /tmp/install_setup

# Note: Skipping external dependencies due to network restrictions
# The following dependencies would normally be installed:
# - libbson, PCRE2, Intel Decimal Math Library, Citus indent
# For production use, ensure network access is available for dependency installation

# Set the working directory inside the container
WORKDIR /build

# Copy the source code into the container
COPY . /build

# Setup the RPM packaging
COPY packaging/rpm_files /build/rpm_files
RUN sed -i "s/POSTGRES_VERSION/${POSTGRES_VERSION}/g" /build/rpm_files/documentdb.spec
RUN sed -i "s/DOCUMENTDB_VERSION/${DOCUMENTDB_VERSION}/g" /build/rpm_files/documentdb.spec

COPY packaging/packaging-entrypoint-rpm.sh /usr/local/bin/packaging-entrypoint-rpm.sh
RUN chmod +x /usr/local/bin/packaging-entrypoint-rpm.sh

# Set the entrypoint
ENTRYPOINT ["packaging-entrypoint-rpm.sh"]